<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management - MedAssist Admin</title>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/components.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="/" class="logo">
          <span class="logo-icon">ðŸ’Š</span>
          <span class="logo-text">MedAssist</span>
          <span class="badge badge-danger">Admin</span>
        </a>
        
        <nav class="nav" id="main-nav">
          <a href="dashboard.html" class="nav-link">Dashboard</a>
          <a href="users.html" class="nav-link active">Users</a>
        </nav>

        <div class="header-actions">
          <div class="user-menu" id="user-menu">
            <button class="user-menu-btn" id="user-menu-btn">
              <span class="user-avatar" id="user-avatar">A</span>
              <span class="user-name" id="user-name">Admin</span>
            </button>
            <div class="dropdown-menu hidden" id="user-dropdown">
              <button class="dropdown-item" id="logout-btn">Logout</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="dashboard-main">
    <div class="container">
      <div class="page-header">
        <h1>User Management</h1>
        <p class="text-secondary">Manage users, pharmacists, and drivers</p>
      </div>

      <!-- User Stats -->
      <div class="stats-grid stats-grid-4">
        <div class="stat-card">
          <div class="stat-value" id="users-count">1,150</div>
          <div class="stat-label">Regular Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pharmacists-count">45</div>
          <div class="stat-label">Pharmacists</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="drivers-count">28</div>
          <div class="stat-label">Drivers</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="admins-count">3</div>
          <div class="stat-label">Admins</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters-bar">
        <div class="search-box-inline">
          <input type="text" class="form-input" id="search-users" placeholder="Search users by name, email, or phone...">
        </div>
        <select class="form-select" id="filter-role">
          <option value="">All Roles</option>
          <option value="user">Users</option>
          <option value="pharmacist">Pharmacists</option>
          <option value="driver">Drivers</option>
          <option value="admin">Admins</option>
        </select>
        <select class="form-select" id="filter-status">
          <option value="">All Status</option>
          <option value="verified">Verified</option>
          <option value="unverified">Unverified</option>
        </select>
      </div>

      <!-- Users Table -->
      <div class="card">
        <div class="table-responsive">
          <table class="table" id="users-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Roles</th>
                <th>Status</th>
                <th>Joined</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users-body">
              <tr>
                <td colspan="7" class="text-center text-secondary">Loading users...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div class="pagination">
          <button class="btn btn-outline btn-sm" id="prev-page" disabled>Previous</button>
          <span class="page-info" id="page-info">Page 1 of 50</span>
          <button class="btn btn-outline btn-sm" id="next-page">Next</button>
        </div>
      </div>
    </div>
  </main>

  <!-- User Detail Modal -->
  <div class="modal hidden" id="user-modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>User Details</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="user-details">
        <!-- User details will be inserted here -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <script src="../../js/api.js"></script>
  <script src="../../js/auth.js"></script>
  <script>
    let currentPage = 1;
    let totalPages = 50;

    document.addEventListener('DOMContentLoaded', async () => {
      // Check if user is logged in and is an admin
      const user = Auth.getUser();
      if (!user || !user.roles.includes('admin')) {
        window.location.href = '../login.html';
        return;
      }

      // Update user info
      document.getElementById('user-name').textContent = user.name || 'Admin';
      document.getElementById('user-avatar').textContent = (user.name || 'A')[0].toUpperCase();

      // Event listeners
      document.getElementById('user-menu-btn').addEventListener('click', () => {
        document.getElementById('user-dropdown').classList.toggle('hidden');
      });

      document.getElementById('logout-btn').addEventListener('click', async () => {
        await Auth.logout();
        window.location.href = '../login.html';
      });

      document.getElementById('search-users').addEventListener('input', debounce(loadUsers, 300));
      document.getElementById('filter-role').addEventListener('change', loadUsers);
      document.getElementById('filter-status').addEventListener('change', loadUsers);
      
      document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          loadUsers();
        }
      });

      document.getElementById('next-page').addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          loadUsers();
        }
      });

      document.querySelector('.modal-backdrop').addEventListener('click', closeModal);

      // Load users
      await loadUsers();
    });

    async function loadUsers() {
      const tbody = document.getElementById('users-body');
      
      // Simulated users data
      const users = [
        { _id: '1', name: 'Admin User', email: 'admin@medassist.com', phone: '+919999990001', roles: ['admin'], is_verified: true, created_at: '2024-01-15' },
        { _id: '2', name: 'John Pharmacist', email: 'pharmacist@medassist.com', phone: '+919999990002', roles: ['pharmacist'], is_verified: true, created_at: '2024-02-10' },
        { _id: '3', name: 'Driver One', email: 'driver_001@medassist.com', phone: '+919999990003', roles: ['driver'], is_verified: true, created_at: '2024-02-15' },
        { _id: '4', name: 'Regular User 1', email: 'user1@example.com', phone: '+919999990004', roles: ['user'], is_verified: true, created_at: '2024-03-01' },
        { _id: '5', name: 'Regular User 2', email: 'user2@example.com', phone: '+919999990005', roles: ['user'], is_verified: false, created_at: '2024-03-10' },
        { _id: '6', name: 'Jane Smith', email: 'jane@example.com', phone: '+919876543210', roles: ['user'], is_verified: true, created_at: '2024-03-15' },
        { _id: '7', name: 'Mike Johnson', email: 'mike@example.com', phone: '+919876543211', roles: ['user'], is_verified: true, created_at: '2024-03-20' }
      ];

      tbody.innerHTML = users.map(user => `
        <tr>
          <td>
            <div class="user-cell">
              <span class="user-avatar-sm">${user.name[0].toUpperCase()}</span>
              <span>${user.name}</span>
            </div>
          </td>
          <td>${user.email}</td>
          <td>${user.phone}</td>
          <td>
            ${user.roles.map(role => `<span class="badge ${getRoleBadgeClass(role)}">${role}</span>`).join(' ')}
          </td>
          <td>
            <span class="badge ${user.is_verified ? 'badge-success' : 'badge-warning'}">
              ${user.is_verified ? 'Verified' : 'Unverified'}
            </span>
          </td>
          <td>${formatDate(user.created_at)}</td>
          <td>
            <button class="btn btn-sm btn-outline" onclick="viewUser('${user._id}')">View</button>
            <button class="btn btn-sm btn-outline" onclick="editUser('${user._id}')">Edit</button>
          </td>
        </tr>
      `).join('');

      // Update pagination
      document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('prev-page').disabled = currentPage <= 1;
      document.getElementById('next-page').disabled = currentPage >= totalPages;
    }

    function getRoleBadgeClass(role) {
      const classes = {
        'admin': 'badge-danger',
        'pharmacist': 'badge-primary',
        'driver': 'badge-info',
        'user': 'badge-secondary'
      };
      return classes[role] || 'badge-secondary';
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('en-IN', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }

    function viewUser(userId) {
      document.getElementById('user-details').innerHTML = `
        <div class="user-detail-section">
          <h4>Basic Information</h4>
          <p><strong>Name:</strong> Regular User 1</p>
          <p><strong>Email:</strong> user1@example.com</p>
          <p><strong>Phone:</strong> +919999990004</p>
          <p><strong>Status:</strong> <span class="badge badge-success">Verified</span></p>
        </div>
        <div class="user-detail-section">
          <h4>Roles</h4>
          <p><span class="badge badge-secondary">user</span></p>
        </div>
        <div class="user-detail-section">
          <h4>Account</h4>
          <p><strong>Joined:</strong> March 1, 2024</p>
          <p><strong>Orders:</strong> 15</p>
          <p><strong>Wallet Balance:</strong> â‚¹250</p>
        </div>
        <div class="user-detail-section">
          <h4>Addresses</h4>
          <p><strong>Home:</strong> 123 Main Street, Mumbai - 400001</p>
        </div>
      `;
      document.getElementById('user-modal').classList.remove('hidden');
    }

    function editUser(userId) {
      alert('Edit functionality would open a form modal');
    }

    function closeModal() {
      document.getElementById('user-modal').classList.add('hidden');
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
  </script>
</body>
</html>
