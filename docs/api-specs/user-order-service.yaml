openapi: 3.0.3
info:
  title: MedAssist User & Order Service API
  description: |
    User management, medicine catalog, and order processing service.
    
    ## ⚠️ Medical Disclaimer
    MedAssist is a platform for purchasing OTC and prescription medicines.
    Always consult with a qualified healthcare professional before taking any medication.
  version: 1.0.0
  contact:
    name: MedAssist Team
    email: support@medassist.com

servers:
  - url: http://localhost:3002
    description: Development server

tags:
  - name: Medicines
    description: Medicine catalog endpoints
  - name: Pharmacies
    description: Pharmacy discovery endpoints
  - name: Orders
    description: Order management endpoints
  - name: Users
    description: User profile endpoints
  - name: Payment
    description: Payment processing endpoints

paths:
  /api/v1/medicines/search:
    get:
      tags:
        - Medicines
      summary: Search medicines
      description: Search medicines with optional geo-filtering
      operationId: searchMedicines
      parameters:
        - name: q
          in: query
          description: Search query
          schema:
            type: string
        - name: lat
          in: query
          description: Latitude for geo-filtering
          schema:
            type: number
        - name: lon
          in: query
          description: Longitude for geo-filtering
          schema:
            type: number
        - name: radius
          in: query
          description: Search radius in km
          schema:
            type: number
            default: 10
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MedicineSearchResponse'

  /api/v1/pharmacies:
    get:
      tags:
        - Pharmacies
      summary: List pharmacies
      description: List pharmacies with optional geo-filtering
      operationId: listPharmacies
      parameters:
        - name: lat
          in: query
          schema:
            type: number
        - name: lon
          in: query
          schema:
            type: number
        - name: radius
          in: query
          schema:
            type: number
            default: 10
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of pharmacies
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PharmacyListResponse'

  /api/v1/pharmacies/{id}/inventory:
    get:
      tags:
        - Pharmacies
      summary: Get pharmacy inventory
      description: Get available medicines in a pharmacy
      operationId: getPharmacyInventory
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: size
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Pharmacy inventory
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InventoryResponse'
        '404':
          description: Pharmacy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/orders:
    post:
      tags:
        - Orders
      summary: Create order
      description: Create a new order with idempotency support
      operationId: createOrder
      security:
        - bearerAuth: []
      parameters:
        - name: Idempotency-Key
          in: header
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
      responses:
        '201':
          description: Order created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Insufficient stock or duplicate order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      tags:
        - Orders
      summary: List user orders
      description: Get orders for the authenticated user
      operationId: listOrders
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [created, accepted_by_pharmacy, prepared, driver_assigned, in_transit, delivered, cancelled, failed]
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of orders
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderListResponse'

  /api/v1/orders/{id}:
    get:
      tags:
        - Orders
      summary: Get order details
      description: Get details of a specific order
      operationId: getOrder
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Order details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/orders/{id}/cancel:
    post:
      tags:
        - Orders
      summary: Cancel order
      description: Cancel an order before dispatch
      operationId: cancelOrder
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
      responses:
        '200':
          description: Order cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Cannot cancel - already dispatched
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/orders/{id}/rate:
    post:
      tags:
        - Orders
      summary: Rate pharmacy
      description: Rate the pharmacy after delivery
      operationId: rateOrder
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - rating
              properties:
                rating:
                  type: integer
                  minimum: 1
                  maximum: 5
                review:
                  type: string
      responses:
        '200':
          description: Rating submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  /api/v1/users/profile:
    get:
      tags:
        - Users
      summary: Get user profile
      operationId: getProfile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
    put:
      tags:
        - Users
      summary: Update user profile
      operationId: updateProfile
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileRequest'
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'

  /api/v1/users/cart:
    put:
      tags:
        - Users
      summary: Update cart
      description: Update user's shopping cart
      operationId: updateCart
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CartRequest'
      responses:
        '200':
          description: Cart updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CartResponse'

  /api/v1/payment/webhook:
    post:
      tags:
        - Payment
      summary: Payment webhook
      description: Simulated payment webhook that emits orders.paid event
      operationId: paymentWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - order_id
                - status
              properties:
                order_id:
                  type: string
                status:
                  type: string
                  enum: [paid, failed]
                transaction_id:
                  type: string
      responses:
        '200':
          description: Webhook processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  /health:
    get:
      summary: Health check
      responses:
        '200':
          description: Service is healthy

  /metrics:
    get:
      summary: Prometheus metrics
      responses:
        '200':
          description: Metrics in Prometheus format

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    MedicineSearchResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            medicines:
              type: array
              items:
                $ref: '#/components/schemas/Medicine'
            total:
              type: integer
            page:
              type: integer
            pages:
              type: integer

    Medicine:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        brand:
          type: string
        generic_name:
          type: string
        salt:
          type: string
        dosage_form:
          type: string
        strength:
          type: string
        prescription_required:
          type: boolean
        tags:
          type: array
          items:
            type: string

    PharmacyListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            pharmacies:
              type: array
              items:
                $ref: '#/components/schemas/Pharmacy'
            total:
              type: integer

    Pharmacy:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        address:
          type: string
        geo:
          type: object
          properties:
            type:
              type: string
            coordinates:
              type: array
              items:
                type: number
        opening_hours:
          type: string
        rating:
          type: number
        rating_count:
          type: integer
        distance:
          type: number

    InventoryResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            pharmacy:
              $ref: '#/components/schemas/Pharmacy'
            inventory:
              type: array
              items:
                $ref: '#/components/schemas/InventoryItem'

    InventoryItem:
      type: object
      properties:
        _id:
          type: string
        medicine:
          $ref: '#/components/schemas/Medicine'
        batch_no:
          type: string
        expiry_date:
          type: string
          format: date
        quantity_available:
          type: integer
        mrp:
          type: number
        selling_price:
          type: number

    CreateOrderRequest:
      type: object
      required:
        - pharmacy_id
        - items
        - shipping_address
      properties:
        pharmacy_id:
          type: string
        items:
          type: array
          items:
            type: object
            required:
              - medicine_id
              - batch_no
              - qty
            properties:
              medicine_id:
                type: string
              batch_no:
                type: string
              qty:
                type: integer
                minimum: 1
        shipping_address:
          type: object
          required:
            - address_line
            - city
            - pincode
          properties:
            address_line:
              type: string
            city:
              type: string
            pincode:
              type: string
            lat:
              type: number
            lon:
              type: number

    OrderResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            order:
              $ref: '#/components/schemas/Order'

    Order:
      type: object
      properties:
        _id:
          type: string
        user_id:
          type: string
        pharmacy_id:
          type: string
        items:
          type: array
          items:
            type: object
            properties:
              medicine_id:
                type: string
              batch_no:
                type: string
              qty:
                type: integer
              price:
                type: number
              tax:
                type: number
        total_amount:
          type: number
        status:
          type: string
          enum: [created, accepted_by_pharmacy, prepared, driver_assigned, in_transit, delivered, cancelled, failed]
        payment_status:
          type: string
          enum: [pending, paid, failed]
        created_at:
          type: string
          format: date-time

    OrderListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            orders:
              type: array
              items:
                $ref: '#/components/schemas/Order'
            total:
              type: integer

    UserProfileResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            user:
              type: object
              properties:
                _id:
                  type: string
                name:
                  type: string
                email:
                  type: string
                phone:
                  type: string
                addresses:
                  type: array
                  items:
                    type: object
                wallet_balance:
                  type: number

    UpdateProfileRequest:
      type: object
      properties:
        name:
          type: string
        addresses:
          type: array
          items:
            type: object
            properties:
              label:
                type: string
              address_line:
                type: string
              city:
                type: string
              pincode:
                type: string
              lat:
                type: number
              lon:
                type: number

    CartRequest:
      type: object
      properties:
        cart:
          type: array
          items:
            type: object
            required:
              - medicine_id
              - pharmacy_id
              - qty
            properties:
              medicine_id:
                type: string
              pharmacy_id:
                type: string
              qty:
                type: integer
              price_at_add:
                type: number

    CartResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            cart:
              type: array
              items:
                type: object

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string

    ErrorResponse:
      type: object
      properties:
        error_code:
          type: string
        message:
          type: string
        details:
          type: object
